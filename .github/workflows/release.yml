name: Build and Release Extension

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (without v prefix, e.g. 1.0.0)"
        required: true
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.resolve.outputs.version }}
      tag: ${{ steps.resolve.outputs.tag }}
      target_sha: ${{ steps.target.outputs.sha }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Fetch tags
      run: git fetch --tags --force

    - name: Resolve release version and tag
      id: resolve
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          tag="v${{ inputs.version }}"
        else
          tag="${GITHUB_REF#refs/tags/}"
        fi

        if ! [[ "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Invalid tag format: $tag"
          exit 1
        fi

        echo "tag=$tag" >> "$GITHUB_OUTPUT"
        echo "version=${tag#v}" >> "$GITHUB_OUTPUT"

    - name: Validate tag exists for manual dispatch
      if: github.event_name == 'workflow_dispatch'
      run: |
        for attempt in 1 2 3 4 5 6; do
          git fetch --tags --force
          if git rev-parse "refs/tags/${{ steps.resolve.outputs.tag }}" >/dev/null 2>&1; then
            exit 0
          fi
          echo "Tag ${{ steps.resolve.outputs.tag }} not available yet (attempt $attempt/6). Retrying..."
          sleep 5
        done

        echo "Tag ${{ steps.resolve.outputs.tag }} does not exist in the repository."
        echo "Create and push the tag first, then rerun this workflow."
        exit 1

    - name: Resolve tag target commit
      id: target
      run: |
        sha="$(git rev-list -n 1 "${{ steps.resolve.outputs.tag }}")"
        if [ -z "$sha" ]; then
          echo "Unable to resolve commit SHA for tag ${{ steps.resolve.outputs.tag }}"
          exit 1
        fi
        echo "sha=$sha" >> "$GITHUB_OUTPUT"

  verify-tests:
    needs: prepare
    runs-on: ubuntu-latest
    permissions:
      actions: read

    steps:
    - name: Ensure tests passed for release commit
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TARGET_SHA: ${{ needs.prepare.outputs.target_sha }}
      run: |
        api_path="repos/${GITHUB_REPOSITORY}/actions/workflows/tests-on-main.yml/runs?head_sha=${TARGET_SHA}&event=push&branch=main&status=completed&per_page=1"
        conclusion="$(gh api "$api_path" --jq '.workflow_runs[0].conclusion // ""')"
        url="$(gh api "$api_path" --jq '.workflow_runs[0].html_url // ""')"

        if [ "$conclusion" != "success" ]; then
          echo "No successful tests run found for commit ${TARGET_SHA}."
          echo "Expected workflow: Run Tests on Main Push"
          if [ -n "$url" ]; then
            echo "Latest matching run: $url (conclusion: $conclusion)"
          fi
          exit 1
        fi

        echo "Tests passed for release commit ${TARGET_SHA}: $url"

  build:
    needs: [prepare, verify-tests]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ needs.prepare.outputs.version }}
      tag: ${{ needs.prepare.outputs.tag }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ needs.prepare.outputs.tag }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"
        cache: "npm"

    - name: Install dependencies
      run: npm ci

    - name: Install webview dependencies
      run: npm ci --prefix web --legacy-peer-deps

    - name: Build extension and web UI
      run: npm run build:all

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          dist/
          web/dist/
          package.json
          package-lock.json
          *.md
          *.js
          *.mjs
          *.json
          resources/
        retention-days: 7

  package:
    needs: [prepare, build]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ needs.prepare.outputs.tag }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"
        cache: "npm"

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts

    - name: Install production dependencies
      run: npm ci --production

    - name: Validate build artifacts
      run: |
        test -f dist/extension.js || (echo "Missing dist/extension.js" && exit 1)
        test -d web/dist || (echo "Missing web/dist directory" && exit 1)
        echo "Build artifacts validated successfully"

    - name: Package VSIX
      run: npx @vscode/vsce@2.32.0 package -o copilot-mcp-${{ needs.build.outputs.version }}.vsix --allow-missing-repository

    - name: Verify VSIX integrity
      run: |
        if [ ! -f "copilot-mcp-${{ needs.build.outputs.version }}.vsix" ]; then
          echo "VSIX file was not created"
          exit 1
        fi

        file_size=$(stat -c%s "copilot-mcp-${{ needs.build.outputs.version }}.vsix")
        if [ "$file_size" -lt 1000000 ]; then
          echo "VSIX file seems too small: $file_size bytes"
          exit 1
        fi

        sha256sum "copilot-mcp-${{ needs.build.outputs.version }}.vsix" > vsix.sha256
        echo "VSIX file verified successfully (size: $file_size bytes)"
        echo "SHA256: $(cat vsix.sha256)"

    - name: Upload VSIX artifact
      uses: actions/upload-artifact@v4
      with:
        name: vsix-package
        path: |
          copilot-mcp-${{ needs.build.outputs.version }}.vsix
          vsix.sha256
        retention-days: 7

  release:
    needs: [prepare, build, package]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download VSIX artifact
      uses: actions/download-artifact@v4
      with:
        name: vsix-package

    - name: Create GitHub release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ needs.prepare.outputs.tag }}
        name: Release ${{ needs.prepare.outputs.tag }}
        generate_release_notes: true
        files: |
          copilot-mcp-${{ needs.build.outputs.version }}.vsix
          vsix.sha256
        draft: false
        prerelease: false

  publish:
    needs: [prepare, build, package, release]
    runs-on: ubuntu-latest
    env:
      VSCE_PAT: ${{ secrets.VSCE_TOKEN }}

    steps:
    - name: Skip Marketplace publish when token is missing
      if: env.VSCE_PAT == ''
      run: echo "VSCE_TOKEN is not configured. Skipping VS Code Marketplace publish."

    - name: Download VSIX artifact
      if: env.VSCE_PAT != ''
      uses: actions/download-artifact@v4
      with:
        name: vsix-package

    - name: Publish to Marketplace
      if: env.VSCE_PAT != ''
      run: npx @vscode/vsce@2.32.0 publish --packagePath copilot-mcp-${{ needs.build.outputs.version }}.vsix
