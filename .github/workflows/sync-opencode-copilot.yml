name: Sync Opencode Copilot Provider

on:
  schedule:
    - cron: "17 4 * * *"
  workflow_dispatch:
    inputs:
      ref:
        description: "Upstream ref to sync (branch, tag, or SHA). Defaults to dev."
        required: false
        type: string

concurrency:
  group: sync-opencode-copilot
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            package-lock.json
            web/package-lock.json

      - name: Install root dependencies
        run: npm ci

      - name: Install web dependencies
        run: npm ci --prefix web

      - name: Sync upstream provider
        env:
          UPSTREAM_REF: ${{ github.event.inputs.ref || '' }}
        run: |
          if [ -n "$UPSTREAM_REF" ]; then
            npm run sync:copilot-provider -- --ref="$UPSTREAM_REF"
          else
            npm run sync:copilot-provider
          fi

      - name: Validate TypeScript
        run: npm run check-types

      - name: Lint extension code
        run: npm run lint

      - name: Run webview tests
        run: npm run test:webview

      - name: Read upstream commit
        id: upstream
        run: |
          echo "commit=$(node -p \"require('./vendor/opencode-copilot/UPSTREAM.json').commit\")" >> "$GITHUB_OUTPUT"
          echo "ref=$(node -p \"require('./vendor/opencode-copilot/UPSTREAM.json').ref\")" >> "$GITHUB_OUTPUT"

      - name: Resolve existing labels
        id: labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPOSITORY: ${{ github.repository }}
        run: |
          labels_json=$(curl -fsSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPOSITORY/labels?per_page=100")

          existing_labels=$(node -e '
            const labels = JSON.parse(process.argv[1] ?? "[]");
            for (const label of labels) {
              if (typeof label?.name === "string") {
                console.log(label.name);
              }
            }
          ' "$labels_json")

          wanted_labels=("dependencies" "automation")
          selected_labels=()
          for label in "${wanted_labels[@]}"; do
            if echo "$existing_labels" | grep -Fxq "$label"; then
              selected_labels+=("$label")
            fi
          done

          labels_csv=$(IFS=,; echo "${selected_labels[*]}")
          echo "value=$labels_csv" >> "$GITHUB_OUTPUT"

      - name: Create sync pull request
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/sync-opencode-copilot
          delete-branch: false
          title: "chore: sync opencode copilot provider"
          commit-message: "chore: sync opencode copilot provider to ${{ steps.upstream.outputs.commit }}"
          body: |
            Automated sync of vendored Copilot provider sources.

            - Upstream repo: `anomalyco/opencode`
            - Upstream ref: `${{ steps.upstream.outputs.ref }}`
            - Upstream commit: `${{ steps.upstream.outputs.commit }}`

            This PR was generated by `.github/workflows/sync-opencode-copilot.yml`.
          labels: ${{ steps.labels.outputs.value }}
